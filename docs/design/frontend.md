## 1. **文档信息**
- **标题**：关系状态感知 App（v1.0）前端架构设计（UniApp Vue3 + Vite + Pinia）
- **设计稿**：TBD（占位：Figma/蓝湖链接）
- **接口文档关联**：后端契约 `Base URL: /api/v1`（Swagger/TBD）；本文严格对齐 BE_DESIGN 中已定义接口与字段

---

## 2. **目的与范围 [必填]**
### 2.1 目标（UX / 体验指标）
- **保活成功率**：被监视方在后台 24h 内可持续上报心跳（目标：≥95%，以“每 5 分钟至少一次上报”作为底线指标）
- **状态可见性**：权限关键变更（定位/通知/安装状态）在监视方端 **60 秒内**可见并可收到强提醒（依赖后端推送链路）
- **流畅度**：地图页刷新与状态卡片渲染保持顺滑（列表/地图更新节流，避免每秒重渲）
- **弱网可用性**：弱网/断网下仍能明确展示“上次更新时间/失联判定”，并引导用户自助排障
- **权限被拒绝可完成主链路**：即使拒绝定位/通知，仍能登录、绑定、进入看板并看到“未授权原因+一键跳转设置”的降级路径

### 2.2 范围（v1.0）
- 账号：手机号验证码登录、单设备绑定（换机自动失效旧设备 token）
- 关系：生成绑定码、输入绑定码建立 1v1 关系；双方确认解绑；强制解绑入口预留（仅 UI 占位）
- 上报：被监视方心跳上报 `/telemetry/heartbeat`（定位/设备/权限摘要）
- 查询：监视方查询对方最新状态 `/telemetry/partner/state`
- 通知：前端接入系统通知权限引导 +（可选）推送 SDK/插件，用于 60 秒内触达

---

## 3. **核心 UX 流程 [必填]**
### 3.1 主流程：入口 -> 页面流转 -> 异常处理
1) **启动页（冷启动/热启动）**
- 读取本地 token（Pinia + 本地持久化），若存在则尝试拉取关系/状态（若后端无“关系查询接口”，则以进入看板后调用 `/telemetry/partner/state` 的结果作为“已绑定”的判据，见 Implementation Notes）
- token 无效/过期：跳转登录页

2) **登录**
- 输入手机号 → 调用 `POST /api/v1/auth/sms/send`（`phone`, `scene: "LOGIN"`）
- 输入验证码 → 调用 `POST /api/v1/auth/login`（`phone`, `smsCode`, `deviceId`, `deviceModel`, `platform`）
- 登录成功：保存 `token`, `expiresInSeconds`, `user.id`, `user.phoneMasked`

3) **关系建立**
- 已绑定用户：直接进入“存活看板/地图”
- 未绑定用户：进入“绑定页”
  - 生成绑定码：`POST /api/v1/relation/bind-code`，展示 6 位码与倒计时 `ttlSeconds`
  - 输入绑定码：`POST /api/v1/relation/bind`（`bindCode`）→ 成功后进入看板

4) **权限剧场化引导（强引导但不阻断）**
- 看板页首次进入弹出“分步引导”：
  1. 定位 Always Allow
  2. 通知权限
  3. 自启动/电池优化白名单
  4. 使用情况访问（Android）
- 每步都提供：`去开启`（跳系统设置/插件）、`暂不`（进入下一步但打上风险标签）

5) **被监视方后台上报（核心）**
- 前台活跃：每 1 分钟触发 `POST /api/v1/telemetry/heartbeat`
- 静止期：以地理围栏/定位变化触发补充上报（UniApp 能力不足部分由插件实现，见第 6 章）

6) **监视方查看**
- 看板/地图页：轮询或页面可见时刷新 `GET /api/v1/telemetry/partner/state`
- 展示：在线状态、上次心跳时间、电量、网络、定位点与更新时间、权限摘要（与后端返回字段一致）

7) **解绑**
- 发起：`POST /api/v1/relation/unbind/request`（`reason`）
- 对方确认：`POST /api/v1/relation/unbind/confirm`（`unbindRequestId`, `confirm: true`）
- 强制解绑：入口展示但默认隐藏/灰态（后端接口 `/relation/unbind/force` 预留）

---

### 3.2 弱网降级路径（必须）
- **短信发送/登录**：
  - 超时/断网：提示“网络不可用，请检查网络后重试”，保留已输入手机号与验证码
  - 重试策略：前端仅做“手动重试 + 退避提示”，避免自动风暴请求触发 `42900`
- **心跳上报**：
  - 弱网重传：允许客户端在本地缓存最近 1~3 次心跳 payload（仅内存/轻量缓存），失败后延迟重试（例如 15s/30s/60s），并保持 payload 中 `timestamp` 为原始值，配合后端幂等
  - UI 呈现：看板显示“上报失败（弱网）/上次成功：xx:xx”，不阻断用户操作
- **状态查询**：
  - 查询失败：保持上次成功数据，卡片顶部显示“数据可能已过期”，并显示上次更新时间
  - 若超过 5 分钟未更新：UI 进入“可能失联”状态（以 `lastHeartbeatAt` 计算），并提供排障入口

### 3.3 权限被拒绝降级路径（必须）
- **定位 Always Allow 被拒绝**：
  - 看板仍可用，但定位卡显示“未授权定位（无法上报位置）”
  - 提供按钮：`去设置开启定位权限`（跳系统设置页），以及“为什么需要”文案
- **通知权限被拒绝**：
  - 看板仍可用，但“60 秒触达”能力降级：提示“无法及时收到告警”
  - 提供按钮：`开启通知`（跳设置）
- **电池白名单/自启动未开启**：
  - 显示“保活风险：高”，提示可能被系统杀死导致失联
  - Android 提供“机型适配指引”入口（跳到内置帮助页）
- **Android 使用情况访问未开启**：
  - v1.0 不阻断主功能，仅在“审计/深度记录（P1）”入口提示需要授权

---

## 4. **UI/交互概览**
### 4.1 路由表（pages.json 结构建议）
- `pages/login/index`：手机号验证码登录
- `pages/bind/index`：绑定码生成/输入
- `pages/dashboard/index`：存活看板（权限状态 + 在线状态 + 设备状态）
- `pages/map/index`：地图实时页（标准/卫星切换、距离展示）
- `pages/permissions/guide`：权限剧场化引导（分步）
- `pages/settings/index`：账号与关系设置（解绑入口、强制解绑占位）
- `pages/help/keepalive`：保活与权限排障手册（Android 机型指引）
- `pages/logs/index`：敏感动作记录/告警列表（v1.0 可先仅展示后端告警占位，P1 扩展）

### 4.2 关键组件清单
- `PermissionStepModal`：权限分步引导弹窗（可复用）
- `StatusCard`：统一状态卡（在线/电量/网络/权限）
- `MapModeToggle`：地图模式切换（标准/卫星）
- `HeartbeatBadge`：心跳状态角标（成功/失败/失联）
- `ActionSheet`：跳系统设置/机型指引入口

---

## 5. **前端架构 [建议]**
### 5.1 目录结构（建议）
- `src/`
  - `app/`：应用初始化、全局拦截、权限能力封装
  - `pages/`：页面
  - `components/`：通用组件
  - `stores/`：Pinia
  - `services/`：API 封装（Auth/Relation/Telemetry）
  - `types/`：与后端契约对齐的 DTO 类型
  - `utils/`：时间、节流、缓存、错误码映射
  - `tests/`：Vitest 单测

### 5.2 网络层封装逻辑（必须对齐后端）
- Base：`/api/v1`
- Header：`Authorization: Bearer <token>`（除登录/发码）
- 响应包装统一解析：
  - `code === 0` 视为成功，`data` 为业务数据
  - 非 0：映射后端错误码（`40100/40101/40901/40902/42900` 等）到统一提示与强制登出逻辑
- 超时与重试：
  - 登录/发码：不自动重试
  - 心跳：允许有限次数重试（弱网）
  - 查询：失败不重试或仅 1 次快速重试，避免刷接口

### 5.3 全局状态定义（Pinia）
- `useAuthStore`
  - `token`, `expiresInSeconds`, `user: { id, phoneMasked }`
  - 动作：`sendSms()`, `login()`, `logout()`
- `useRelationStore`
  - `relationId`, `partnerUserId`, `status`
  - 动作：`generateBindCode()`, `bindByCode()`, `unbindRequest()`, `unbindConfirm()`
- `useTelemetryStore`
  - `partnerState`（严格对齐 `/telemetry/partner/state` 返回结构）
  - `lastHeartbeatServerTime`
  - 动作：`uploadHeartbeat(payload)`, `fetchPartnerState()`
- `usePermissionStore`
  - 本地计算的权限状态（用于组装 heartbeat.permission）
  - 引导步骤完成度、用户是否“暂不”过

---

## 6. **第三方库与插件**
### 6.1 地图与定位
- 优先 UniApp 标准能力：`uni.getLocation`（前台定位）
- 若需要后台定位/地理围栏：
  - 使用 UniApp 插件市场的“后台定位/地理围栏”插件（需评估 iOS/Android 合规与审核风险）
  - 地图展示可选：
    - `map` 组件（原生地图能力）
    - 若需要卫星图层：评估各平台 map 组件支持度，必要时引入地图 SDK 插件（高风险点需评审）

### 6.2 推送与通知
- App 端推送建议接入成熟推送插件（厂商通道聚合），用于满足“60 秒内触达”
- 本地通知：用于弱网/无推送兜底提醒（仍需系统通知权限）

### 6.3 设备信息/权限探测
- `uni.getSystemInfo`（设备型号/平台基础信息）
- Android 电池白名单/自启动/使用情况访问：通常需原生能力或插件支持（以插件市场为主）

---

## 7. **保活与系统权限 [针对本项目]**
### 7.1 权限申请触发时机（iOS / Android）
1) **登录成功后首次进入看板**
- 触发“权限剧场化引导”（不直接弹系统框，先解释用途，再点“去开启”）
2) **心跳上报失败且原因疑似权限缺失**
- 触发对应权限的二次引导（更短文案 + 直达设置）
3) **监视方端出现“对方失联/权限关闭”**
- 引导监视方提醒对方开启（前端提供一键复制提醒文案/模板）

### 7.2 引导文案（可直接用于 UI）
- **定位 Always Allow**
  - 标题：开启“始终允许定位”
  - 说明：用于在后台持续上报位置与到达/离开提醒；不开启将导致“失联/定位不可用”
  - 按钮：`去开启定位权限` / `暂不（可能失联）`
- **通知权限**
  - 标题：开启通知
  - 说明：当对方关闭权限/失联时，需要在 60 秒内提醒你；不开启可能错过关键告警
  - 按钮：`开启通知` / `暂不`
- **电池优化白名单 / 自启动（Android）**
  - 标题：允许后台常驻
  - 说明：关闭电池优化/允许自启动可显著降低系统杀后台概率，提升保活成功率
  - 按钮：`去系统设置` / `查看机型教程`
- **使用情况访问（Android）**
  - 标题：允许“使用情况访问”
  - 说明：用于统计解锁与使用时长（会员审计能力）；不开启不影响基础定位
  - 按钮：`去开启` / `稍后`

### 7.3 保活策略（前端侧可落地）
- 前台：定时器 + 页面可见性监听（节流刷新）
- 后台（需要插件/原生能力支持）：前台服务（Android）、后台定位、JobScheduler/WorkManager 触发心跳
- 失联判定展示：严格基于后端 `lastHeartbeatAt` 与 `onlineStatus`，前端只做辅助提示，不自行写死状态

---

## Implementation Notes（契约冲突/缺口记录）
- 后端已定义的查询接口只有 `GET /api/v1/telemetry/partner/state`，但前端在“启动后判断是否已绑定关系/关系状态”可能需要：
  - 关系查询接口（例如 `/relation/me`）或在 `partner/state` 返回 `relationId/status`；当前契约未提供，前端只能通过请求 `partner/state` 失败码来推断（不够稳定）。
- 解绑强制出口 `/relation/unbind/force` 已定义，但鉴权/二次因子获取（短信发送 scene/type）未在后端契约中给出；前端仅做入口占位，具体二次验证流程需补齐接口。
- 推送通道未在后端契约中定义（BE 说明为适配层），前端需要确定实际推送 SDK/插件选型与 token 上报机制（当前契约无“pushToken 注册接口”）。

--- 

如你希望我把这份设计进一步落到“可直接开工”的粒度（`pages.json` 示例、Pinia store/Service 的 TypeScript DTO、Vitest 用例清单、权限引导页面结构），把你们的项目包名与是否已有统一请求封装/返回体工具发我即可。